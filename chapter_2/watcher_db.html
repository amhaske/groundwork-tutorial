<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2.1. Simple watcher database &#8212; groundwork tutorial 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/groundwork.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2.2. Complex history database" href="history_db.html" />
    <link rel="prev" title="2. groundwork and databases" href="index.html" />
     
        
    <link rel="apple-touch-icon" href="../_static/""" />
        
    <link media="only screen and (max-device-width: 480px)" href="../_static/small_groundwork.css" type= "text/css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="history_db.html" title="2.2. Complex history database"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="2. groundwork and databases"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">groundwork tutorial 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">2. groundwork and databases</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="simple-watcher-database">
<span id="watcher-db"></span><h1>2.1. Simple watcher database<a class="headerlink" href="#simple-watcher-database" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If not done yet, please install <strong>groundwork-database</strong>:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">groundwork</span><span class="o">-</span><span class="n">database</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Example code</p>
<p class="last">You can get the complete code of this chapter from
<a class="reference external" href="https://github.com/useblocks/groundwork-tutorial/tree/master/code/chapter_2/01_database/CSV-Manager">github</a></p>
</div>
<p>During the following steps we will:</p>
<ul class="simple">
<li>Create a new plugin <cite>CsvWatcherDbPlugin</cite></li>
<li>Define some config parameters, which are needed for our database</li>
<li>Register a SQLite database</li>
<li>Define and register a database model</li>
<li>Write functions to add, delete and list watchers</li>
</ul>
<div class="section" id="plugin-creation">
<h2>2.1.1. Plugin creation<a class="headerlink" href="#plugin-creation" title="Permalink to this headline">¶</a></h2>
<p>At first we need to set up a new plugin. So create a folder <cite>csv_watcher_db_plugin</cite> inside the folder
<cite>csv_manager/plugins</cite>. Then create two files in it: <cite>__init__.py</cite> and <cite>csv_watcher_db_plugin.py</cite>.</p>
<p>Finally let&#8217;s add some code to our new <cite>csv_watcher_db_plugin.py</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">click</span> <span class="k">import</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Option</span>

<span class="kn">from</span> <span class="nn">groundwork.patterns</span> <span class="k">import</span> <span class="n">GwCommandsPattern</span>
<span class="kn">from</span> <span class="nn">groundwork_database.patterns</span> <span class="k">import</span> <span class="n">GwSqlPattern</span>
<span class="kn">from</span> <span class="nn">csv_manager.patterns</span> <span class="k">import</span> <span class="n">CsvWatcherPattern</span>


<span class="k">class</span> <span class="nc">CsvWatcherDbPlugin</span><span class="p">(</span><span class="n">GwCommandsPattern</span><span class="p">,</span> <span class="n">CsvWatcherPattern</span><span class="p">,</span> <span class="n">GwSqlPattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A plugin for monitoring csv files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;CsvWatcherDbPlugin&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Argument for our command, which stores the csv file path.</span>
        <span class="n">path_argument</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">((</span><span class="s2">&quot;csv_file&quot;</span><span class="p">,),</span>
                                 <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">interval_option</span> <span class="o">=</span> <span class="n">Option</span><span class="p">((</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--interval&quot;</span><span class="p">),</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the time between two checks in seconds&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;csv_watcher_list&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Shows all csv watchers&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">csv_watcher_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;csv_watcher_add&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Adds a permanent watcher&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">csv_watcher_add</span><span class="p">,</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">path_argument</span><span class="p">,</span> <span class="n">interval_option</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;csv_watcher_delete&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Removes a permanent watcher&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">csv_watcher_delete</span><span class="p">,</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">path_argument</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>As you can see, our plugin will provide three new commands to the user: <cite>csv_watcher_list</cite>, <cite>csv_watcher_add</cite> and
<cite>csv_watcher_delete</cite>.</p>
<p><cite>csv_watcher_list</cite> will provide a list of all stored watchers in our database.
<cite>csv_watcher_add</cite> will add a new watcher to our database, so that it will still be available after an application
restart.
And <cite>csv_watcher_delete</cite> will delete an existing watcher from our database.</p>
<p>But before we can use these functions, we have to setup our database.</p>
</div>
<div class="section" id="configuration-preparation">
<h2>2.1.2. Configuration preparation<a class="headerlink" href="#configuration-preparation" title="Permalink to this headline">¶</a></h2>
<p>Currently groundwork-database only supports sql-based database like MySQL, Postgresql, SQLite and more.</p>
<p>We will use <a class="reference external" href="https://sqlite.org/">SQLite</a>,
because it does not need any installation and is
<a class="reference external" href="https://docs.python.org/3.5/library/sqlite3.html">part of Python&#8217;s standard library</a>.</p>
<p>Let&#8217;s add the following configurations to our <code class="docutils literal"><span class="pre">configuration.py</span></code> file inside the <code class="docutils literal"><span class="pre">csv_manager/applications</span></code> folder:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">WATCHER_DATABASE_NAME</span> <span class="o">=</span> <span class="s2">&quot;WATCHER_DB&quot;</span>
<span class="n">WATCHER_DATABASE_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;DB for CSV file watchers&quot;</span>
<span class="n">WATCHER_DATABASE_LOCATION</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/watcher_db.db&quot;</span> <span class="o">%</span> <span class="n">APP_PATH</span>
<span class="n">WATCHER_DATABASE_CONNECTION</span> <span class="o">=</span> <span class="s2">&quot;sqlite:///</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">WATCHER_DATABASE_LOCATION</span>
</pre></div>
</div>
<p>We use the prefix <strong>WATCHER_DATABASE</strong> here to identify easily, which configuration parameters belong to each other.</p>
<p><strong>NAME</strong> and <strong>DESCRIPTION</strong> is for documentation only. <strong>LOCATION</strong> stores the file path only and becomes
part of the important <strong>CONNECTION</strong> parameter, which contains the database type and the uri, which is used as address
to connect to our database.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Take a look into the
<a class="reference external" href="http://docs.sqlalchemy.org/en/latest/core/engines.html">SQLAlchemy documentation about Engine Configuration</a>
for specific information about all supported databases and their needed connection parameter.</p>
</div>
</div>
<div class="section" id="database-registration">
<h2>2.1.3. Database registration<a class="headerlink" href="#database-registration" title="Permalink to this headline">¶</a></h2>
<p>For database registration and configuration we will create a function called <code class="docutils literal"><span class="pre">setup_db()</span></code>, which we call in our
<code class="docutils literal"><span class="pre">activation()</span></code> routine:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="c1">#  ...</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">setup_db</span><span class="p">()</span>


 <span class="k">def</span> <span class="nf">setup_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databases</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WATCHER_DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;csv_watcher_db&quot;</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WATCHER_DATABASE_CONNECTION&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite://&quot;</span><span class="p">),</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WATCHER_DATABASE_DESCRIPTION&quot;</span><span class="p">,</span> <span class="s2">&quot;Stores csv watchers&quot;</span><span class="p">))</span>
     <span class="n">Base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Base</span>

     <span class="k">class</span> <span class="nc">CsvWatchers</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
         <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;csv_watchers&#39;</span>

         <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
         <span class="n">csv_file</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
         <span class="n">interval</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">CsvWatchers</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>groundwork supports the usage and registration of multiple databases. But we only need one, so we register it in
line 7. As return value we get a database object, which we will use for all interactions with our database.</p>
<p>In line 10 we request the SQLAlchemy Base class. SQLAlchemy allows us to define python classes to handle our database
data. But we need to make sure that these classes always inherit from this base class.</p>
<p>Our database table - or better database model - is defined from line 12 to 17.
We use <code class="docutils literal"><span class="pre">__tablename__</span></code> to define our own name for table. If we do not set this value, SQLAlchemy generates a name
based on the class name.</p>
<p>We need and therefore create 3 columns: <strong>id</strong>, <strong>csv_file</strong> and <strong>interval</strong>.</p>
<p>There should be always an id column, so that each row can be clearly identified by this value.
If <code class="docutils literal"><span class="pre">nullable</span></code> is True, the column is allowed to be empty.</p>
<p>Final we register this class on our database [19].</p>
<p>The command <code class="docutils literal"><span class="pre">self.db.create_all()</span></code> tells SQLAlchemy that the configuration is done and that it shall create our
tables, if they do not exist yet.</p>
</div>
<div class="section" id="working-with-database-models">
<h2>2.1.4. Working with database models<a class="headerlink" href="#working-with-database-models" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s time to use our newly created database model and add some data.</p>
<div class="section" id="loading-existing-watchers">
<h3>2.1.4.1. Loading existing watchers<a class="headerlink" href="#loading-existing-watchers" title="Permalink to this headline">¶</a></h3>
<p>But before we can add watchers, we should implement a function, which loads existing watchers and starts
their monitoring thread. So we add a function called <code class="docutils literal"><span class="pre">load_watchers()</span></code> und load it during our <code class="docutils literal"><span class="pre">activate()</span></code>
routine:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="c1">#  ...</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">setup_db</span><span class="p">()</span>
     <span class="n">load_watchers</span><span class="p">()</span>

 <span class="k">def</span> <span class="nf">load_watchers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="n">current_watchers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">watcher</span> <span class="ow">in</span> <span class="n">current_watchers</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">activate_watcher</span><span class="p">(</span><span class="n">watcher</span><span class="o">.</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">watcher</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t activate watcher for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">watcher</span><span class="o">.</span><span class="n">csv_file</span><span class="p">)</span>

 <span class="k">def</span> <span class="nf">activate_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
     <span class="k">try</span><span class="p">:</span>
         <span class="c1"># Register thread</span>
         <span class="n">watcher_thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_watcher</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;Watcher for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">csv_file</span><span class="p">)</span>

         <span class="c1"># Start thread</span>
         <span class="k">if</span> <span class="n">watcher_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
             <span class="n">watcher_thread</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="k">raise</span> <span class="n">e</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Watcher started for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">csv_file</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>In line 7 we query for all our watchers from database. All we need for this is our database model class.</p>
<p>As you can see, we can use the return value as a normal python list and iterate over it [8].</p>
<p>And each object in this list is an instance of our database model class, so we are able to access its data like we
would do with other python class [10, 12].</p>
<p>The <code class="docutils literal"><span class="pre">activate_watcher()</span></code> function activates a single watcher. It is not part of the <code class="docutils literal"><span class="pre">load_watchers()</span></code> routine,
because we will reuse it later inside our watcher creation function.</p>
</div>
<div class="section" id="show-watchers">
<h3>2.1.4.2. Show watchers<a class="headerlink" href="#show-watchers" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s add the command function to print a list of currently existing watchers in our database:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">csv_watcher_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">watchers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">watcher</span> <span class="ow">in</span> <span class="n">watchers</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file: </span><span class="si">%s</span><span class="s2"> - interval: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">watcher</span><span class="o">.</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">watcher</span><span class="o">.</span><span class="n">interval</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-watchers">
<h3>2.1.4.3. Adding watchers<a class="headerlink" href="#adding-watchers" title="Permalink to this headline">¶</a></h3>
<p>And now the interesting part, we create a new watcher:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">csv_watcher_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
     <span class="n">watcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">csv_file</span><span class="o">=</span><span class="n">csv_file</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
     <span class="k">if</span> <span class="n">watcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;csv file </span><span class="si">%s</span><span class="s2"> already exists in database.&quot;</span> <span class="o">%</span> <span class="n">watcher</span><span class="o">.</span><span class="n">csv_file</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="n">watcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span><span class="p">(</span><span class="n">csv_file</span><span class="o">=</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">watcher</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create csv_file </span><span class="si">%s</span><span class="s2"> in database&quot;</span> <span class="o">%</span> <span class="n">csv_file</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="k">try</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">activate_watcher</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
             <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Before we can create a new watcher, we must be sure that it has not been already added to our database [2-4].</p>
<p>To create a new row in our database table, we need to:</p>
<ol class="arabic simple">
<li>Create an instance of our database model and set its values [7]</li>
<li>Add this instance to our database [8]</li>
<li>And final commit the change to our database [17]</li>
</ol>
<p>In line 13 we also try to activate our watcher and start the monitoring.</p>
<p>If something goes wrong during creation or activation of our watcher, we are able to rollback all changes [15].</p>
</div>
<div class="section" id="deleting-watchers">
<h3>2.1.4.4. Deleting watchers<a class="headerlink" href="#deleting-watchers" title="Permalink to this headline">¶</a></h3>
<p>If we can add data, we should also be able to delete data. So lets add the delete function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">csv_watcher_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Watcher</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">csv_file</span><span class="o">=</span><span class="n">csv_file</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Watcher for </span><span class="si">%s</span><span class="s2"> removed&quot;</span> <span class="o">%</span> <span class="n">csv_file</span><span class="p">)</span>
</pre></div>
</div>
<p>That&#8217;s it, watchers can now be created and deleted via command line command. And our application does not loose them,
if it gets restarted.</p>
<p>In the next chapter <a class="reference internal" href="history_db.html#history-db"><span class="std std-ref">Complex history database</span></a> we will use several database models, which have relations to each other.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/gw_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2.1. Simple watcher database</a><ul>
<li><a class="reference internal" href="#plugin-creation">2.1.1. Plugin creation</a></li>
<li><a class="reference internal" href="#configuration-preparation">2.1.2. Configuration preparation</a></li>
<li><a class="reference internal" href="#database-registration">2.1.3. Database registration</a></li>
<li><a class="reference internal" href="#working-with-database-models">2.1.4. Working with database models</a><ul>
<li><a class="reference internal" href="#loading-existing-watchers">2.1.4.1. Loading existing watchers</a></li>
<li><a class="reference internal" href="#show-watchers">2.1.4.2. Show watchers</a></li>
<li><a class="reference internal" href="#adding-watchers">2.1.4.3. Adding watchers</a></li>
<li><a class="reference internal" href="#deleting-watchers">2.1.4.4. Deleting watchers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">2. groundwork and databases</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">2. groundwork and databases</a></li>
      <li>Next: <a href="history_db.html" title="next chapter">2.2. Complex history database</a></li>
  </ul></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/chapter_2/watcher_db.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
    
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    

        </div>
      </div>
      <div class="clearer"></div>
    </div>
 
        <div class="github_fork">
            <a href="http://github.com/useblocks/groundwork-tutorial">
                <img style="position: fixed; top: 0; right: 0; border: 0;"
                     src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"
                     alt="Fork me on GitHub">
            </a>
        </div>
    


    <div class="footer">
      &copy; Copyright 2017, team useblocks.
    </div>
  </body>
</html>